<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å†/è®ºæ–‡å•ä¸ªå¤„ç†</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- é…ç½®Tailwind -->
    <script>
        tailwind.config = {
            content: ["./*.html"],
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#10b981',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex items-center justify-center p-4">
    <!-- ä¸»å®¹å™¨ï¼ˆä½¿ç”¨åŸç”ŸTailwindç±»ï¼‰ -->
    <div class="bg-white p-6 md:p-10 rounded-xl max-w-4xl w-full mx-4 card-shadow">
        <!-- æ ‡é¢˜ -->
        <h2 class="text-2xl md:text-3xl font-bold text-primary text-center">ç®€å†/è®ºæ–‡å•ä¸ªè¾“å…¥</h2>

        <br>

        <div class="flex justify-end mb-6 max-w-3xl mx-auto">
        <!-- è¿”å›/è·³è½¬æŒ‰é’® -->
            <a href="start_page.html" class="text-sm text-gray-600 hover:text-gray-800 transition-colors duration-200">
                <button id="newBtn" class="font-medium py-2 px-4 rounded-lg text-sm bg-blue-600 text-white hover:bg-blue-700 transition-all duration-200 ml-4">
                    å¼€å§‹é¡µ
                </button>
            </a>
            <a href="batch.html" class="text-sm text-gray-600 hover:text-gray-800 transition-colors duration-200">
                <button id="newBtn" class="font-medium py-2 px-4 rounded-lg text-sm bg-gray-600 text-white hover:bg-gray-700 transition-all duration-200 ml-4">
                    æ‰¹é‡è¾“å…¥
                </button>
            </a>
        </div>

        <div class="relative mt-2 mb-2 max-w-3xl mx-auto">
            <!-- ä¸»å®¹å™¨ - å¸¦è¾¹æ¡† -->
            <div class="border-2 border-gray-300 rounded-lg p-2 px-4 relative bg-white">
                <h3 class="text-xl font-bold text-gray-800 mb-0">PDF/URLè¾“å…¥äºŒé€‰ä¸€</h3>
            </div>
        </div>

        <!-- è¡¨å• -->
        <form id="uploadForm" class="space-y-6">
            <div class="relative mt-10 mb-10 max-w-3xl mx-auto">
                <!-- ä¸»å®¹å™¨ - å¸¦è¾¹æ¡† -->
                <div class="border-2 border-gray-300 rounded-lg p-8 pt-16 relative bg-white">
                    <!-- å·¦ä¸Šè§’çªå‡ºçš„ä¸¤ä¸ªæ–¹å—æŒ‰é’® -->
                    <div class="absolute -top-4 -left-4 flex space-x-2 z-10">
                        <div id="pdfTab" class="w-32 h-12 bg-primary text-white flex items-center justify-center cursor-pointer rounded shadow-lg transform transition-transform hover:scale-105 active:scale-95">
                            <span class="font-bold">PDFæ–‡ä»¶è¾“å…¥</span>
                        </div>
                        <div id="urlTab" class="w-32 h-12 bg-gray-200 text-gray-700 flex items-center justify-center cursor-pointer rounded shadow-lg transform transition-transform hover:scale-105 active:scale-95">
                            <span class="font-bold">URLé“¾æ¥è¾“å…¥</span>
                        </div>
                    </div>
                    
                    <!-- 
                    å†…å®¹åŒºåŸŸæ ‡é¢˜ 
                    <h3 class="text-xl font-bold text-gray-800 mb-6">è¯·ä¸Šä¼ æ‚¨çš„ç®€å†/è®ºæ–‡</h3>
                    -->
                    
                    
                    <!-- PDFä¸Šä¼ åŒºåŸŸ (é»˜è®¤æ˜¾ç¤º) -->
                    <div id="pdfContent" class="space-y-4">
                        <label for="pdfContent" class="text-lg font-semibold text-gray-800 mb-2 flex items-center">ç®€å†/è®ºæ–‡ä¸Šä¼ </label>
                        <div class="flex flex-col md:flex-row gap-4 p-5 bg-gray-50 border border-gray-200 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0 0V8m0 4h4m-4 0H8m8 4v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v7a2 2 0 01-2 2h-1"/>
                            </svg>
                            <div class="flex-1">
                                <p class="text-gray-500 text-sm">æ”¯æŒPDFæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡10MB</p>
                                <input id="pdfContent" name="pdfContent" type="file" accept="application/pdf" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all mt-2" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- URLè¾“å…¥åŒºåŸŸ (é»˜è®¤éšè—) -->
                    <div id="urlContent" class="space-y-4 hidden">
                        <label for="paperUrl" class="text-lg font-semibold text-gray-800 mb-2 flex items-center">è®ºæ–‡é“¾æ¥</label>
                        <input id="paperUrl" name="paperUrl" type="url" placeholder="ä¾‹å¦‚ï¼šhttps://arxiv.org/pdf/xxxx.xxx" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
                    </div>
                </div>
            </div>

            <script>
                // è·å–DOMå…ƒç´ 
                const pdfTab = document.getElementById('pdfTab');
                const urlTab = document.getElementById('urlTab');
                const pdfContent = document.getElementById('pdfContent');
                const urlContent = document.getElementById('urlContent');
                
                // ç‚¹å‡»ç¬¬ä¸€ä¸ªæ–¹å—æ˜¾ç¤ºPDFä¸Šä¼ åŒºåŸŸ
                pdfTab.addEventListener('click', () => {
                    // åˆ‡æ¢å†…å®¹æ˜¾ç¤ºçŠ¶æ€
                    pdfContent.classList.remove('hidden');
                    urlContent.classList.add('hidden');
                    
                    // åˆ‡æ¢æŒ‰é’®æ ·å¼
                    pdfTab.classList.remove('bg-gray-200', 'text-gray-700');
                    pdfTab.classList.add('bg-primary', 'text-white');
                    urlTab.classList.remove('bg-primary', 'text-white');
                    urlTab.classList.add('bg-gray-200', 'text-gray-700');
                    
                    // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                    pdfContent.style.opacity = '0';
                    setTimeout(() => {
                        pdfContent.style.transition = 'opacity 0.3s ease-in-out';
                        pdfContent.style.opacity = '1';
                    }, 10);
                });
                
                // ç‚¹å‡»ç¬¬äºŒä¸ªæ–¹å—æ˜¾ç¤ºURLè¾“å…¥åŒºåŸŸ
                urlTab.addEventListener('click', () => {
                    // åˆ‡æ¢å†…å®¹æ˜¾ç¤ºçŠ¶æ€
                    pdfContent.classList.add('hidden');
                    urlContent.classList.remove('hidden');
                    
                    // åˆ‡æ¢æŒ‰é’®æ ·å¼
                    urlTab.classList.remove('bg-gray-200', 'text-gray-700');
                    urlTab.classList.add('bg-primary', 'text-white');
                    pdfTab.classList.remove('bg-primary', 'text-white');
                    pdfTab.classList.add('bg-gray-200', 'text-gray-700');
                    
                    // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
                    urlContent.style.opacity = '0';
                    setTimeout(() => {
                        urlContent.style.transition = 'opacity 0.3s ease-in-out';
                        urlContent.style.opacity = '1';
                    }, 10);
                });
            </script>

            
        </form>


        <!-- æŒ‰é’®åŒºåŸŸ -->
        <div class="relative mt-6 mb-6 max-w-3xl mx-auto">
            <div class="border-2 border-gray-300 rounded-lg p-6 py-4 relative bg-white flex items-center justify-center min-h-[120px]">
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="startBtn" class="font-medium py-2 px-6 rounded-lg text-base bg-primary text-white hover:bg-primary/90 hover:shadow-md active:scale-95 transition-all duration-200">
                        å¼€å§‹ä»»åŠ¡
                    </button>
                    <button id="resetBtn" class="font-medium py-2 px-6 rounded-lg text-base bg-gray-600 text-white hover:bg-gray-700 hover:shadow-md active:scale-95 transition-all duration-200">
                        æ¸…ç©ºç•Œé¢
                    </button>
                </div>
            </div>
        </div>
        

        <!-- è¾“å‡ºä¸æ—¥å¿—åŒºåŸŸ -->
        <div class="flex flex-col md:flex-row gap-6 w-full max-w-3xl mx-auto">
            <div class="flex-1">
                <label class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                    åˆ†æç»“æœ
                    <span class="flex-1 h-px bg-gray-200 ml-3"></span>
                </label>
                <div id="outputArea" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-72 md:h-80 overflow-auto">
                    <div class="text-gray-500 italic">è¯·ä¸Šä¼ ç®€å†å¹¶ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"ï¼Œåˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
            <div class="flex-1">
                <label class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                    å¤„ç†æ—¥å¿—
                    <span class="flex-1 h-px bg-gray-200 ml-3"></span>
                </label>
                <div id="tasklogArea" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-72 md:h-80 overflow-auto">
                    <div class="text-gray-500 italic">ç³»ç»Ÿæ“ä½œæ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
                </div>
            </div>
        </div>
        
        
    </div>
    <script>
        // è·å–æŒ‰é’®å…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tasklogArea = document.getElementById('tasklogArea');
        const outputArea = document.getElementById('outputArea');

        function saveLogsToStorage() {
            const logEntries = Array.from(tasklogArea.querySelectorAll('.log-entry'))
                .map(entry => ({
                    message: entry.querySelector('.log-content').textContent,
                    type: entry.className.split(' ').find(cls => cls.startsWith('log-'))?.replace('log-', '') || 'info'
                }));
            
            localStorage.setItem('taskLogs', JSON.stringify(logEntries));
        }

        // ä»localStorageæ¢å¤æ—¥å¿—
        function loadLogsFromStorage() {
            const savedLogs = localStorage.getItem('taskLogs');
            if (savedLogs) {
                try {
                    const logs = JSON.parse(savedLogs);
                    logs.forEach(log => addLog(log.message, log.type));
                } catch (e) {
                    console.error('Failed to load logs from storage', e);
                    localStorage.removeItem('taskLogs'); // æ¸…é™¤æŸåçš„æ—¥å¿—æ•°æ®
                }
            }
        }

        // æ¸…ç©ºæ—¥å¿—ï¼ˆç”¨äºé‡ç½®æŒ‰é’®ï¼‰
        function clearLogs() {
            tasklogArea.innerHTML = '';
            localStorage.removeItem('taskLogs');
        }

        // å®šä¹‰ä¸€ä¸ªaddLogå‡½æ•°
        function addLog(message, type = 'info') {
            //const timestamp = new Date();
            //const timeString = timestamp.toLocaleTimeString(); æš‚æ—¶æ²¡æœ‰ç”¨
            
            // åˆ›å»ºæ—¥å¿—æ¡ç›®
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            // è®¾ç½®å›¾æ ‡
            let icon = 'â„¹ï¸';
            switch(type) {
                case 'error': icon = 'âš ï¸'; break;
                case 'success': icon = 'âœ…'; break;
            }
            
            logEntry.innerHTML = `
                <div class="log-icon">${icon}</div>
                <div class="log-content">${message}</div>
            `;
            
            tasklogArea.appendChild(logEntry);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            tasklogArea.scrollTop = tasklogArea.scrollHeight;
        
            saveLogsToStorage();
        }

        // æ ¼å¼åŒ–è¾“å‡ºç»“æœï¼Œä½¿å…¶ä¸æ—¥å¿—é£æ ¼ä¸€è‡´
        function formatResult(data) {
            // å®šä¹‰è¦å±•ç¤ºçš„å­—æ®µåŠå…¶æ ‡ç­¾ï¼ŒæŒ‰æŒ‡å®šé¡ºåºæ’åˆ—
            const fields = [
                { key: 'cdd_score', label: 'CDDè¯„åˆ†' },
                { key: 'job_match_1', label: 'æ¨èå²—ä½1' },
                { key: 'job_match_1_contact', label: 'å²—ä½1è”ç³»æ–¹å¼' },
                { key: 'reason_1', label: 'æ¨èç†ç”±1' },
                { key: 'job_match_2', label: 'æ¨èå²—ä½2' },
                { key: 'job_match_2_contact', label: 'å²—ä½2è”ç³»æ–¹å¼' },
                { key: 'reason_2', label: 'æ¨èç†ç”±2' }
            ];
            
            // åˆ›å»ºç»“æœå®¹å™¨
            const resultContainer = document.createElement('div');
            resultContainer.className = 'analysis-result';
            
            // æ·»åŠ æ ‡é¢˜
            const title = document.createElement('div');
            title.className = 'result-title log-entry log-info';
            title.innerHTML = `
                <div class="log-icon">ğŸ“Š</div>
                <div class="log-content">åˆ†æç»“æœ</div>
            `;
            resultContainer.appendChild(title);
            
            // æŒ‰é¡ºåºæ·»åŠ å„ä¸ªå­—æ®µ
            fields.forEach(field => {
                const value = data[field.key] !== null ? data[field.key] : 'æ— ';
                const fieldElement = document.createElement('div');
                fieldElement.className = 'result-field log-entry log-info';
                fieldElement.innerHTML = `
                    <div class="log-icon">â€¢</div>
                    <div class="log-content"><strong>${field.label}:</strong> ${value}</div>
                `;
                resultContainer.appendChild(fieldElement);
            });
            
            return resultContainer;
        }

        // å®šä¹‰ä¸€ä¸ªæ¥æ”¶resumePdfçš„å‡½æ•°
        function cdd_analysis(formData){
                //if (!formData.get('paperUrl1') && !formData.get('paperUrl2')) {
                  //  addLog('æ²¡æœ‰è®ºæ–‡é“¾æ¥çš„è¯ï¼Œæˆ‘ä»¬å°±è·³è¿‡å’¯~', 'info');
                //}
                addLog('å¼€å§‹è¿›è¡Œåˆ†æ...', 'info');
                // 
                fetch('http://localhost:5000/api/llm/cdd/analysis', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error;
                    }
                    return response.json();
                })
                .then(result =>{
                    if (result.status === 'success') {
                        addLog('ç®€å†åˆ†æå®Œæˆï¼', 'success');
                        outputArea.innerHTML = '';
                        outputArea.appendChild(formatResult(result.data));
                    } else {
                        addLog(`åˆ†æå¤±è´¥ï¼šè¯·é‡è¯•ä¸€ä¸‹å§`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š${error.message}`, 'error');
                });
            };

        // é¡µé¢åŠ è½½æ—¶æ¢å¤æ—¥å¿—
        //window.addEventListener('load', loadLogsFromStorage);

        // ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆç¡®ä¿ä¼ å…¥å®Œæ•´çš„formDataï¼‰
        startBtn.addEventListener('click', async function() {
            clearLogs(); // æ¸…ç©ºæ—¥å¿—åŒºåŸŸ
            const formData = new FormData(document.getElementById('uploadForm'));
            const pdfFile = formData.get('pdfContent');
            const paperUrl = formData.get('paperUrl');

            // æ£€æŸ¥æ˜¯å¦ä¸Šä¼ äº†æ•°æ®
            if (pdfFile.size==0 && !paperUrl) {
                addLog('è¯·å…ˆä¸Šä¼ æ•°æ®', 'error');
                return;
            }

            addLog('æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨ç­‰...', 'info');
            cdd_analysis(formData);
        });

        // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        resetBtn.addEventListener('click', function() {
            clearLogs(); // æ¸…ç©ºæ—¥å¿—åŒºåŸŸ
            outputArea.innerHTML = '<div class="text-gray-500 italic">è¯·ä¸Šä¼ ç®€å†å¹¶ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"ï¼Œåˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>';
            document.getElementById('uploadForm').reset(); // é‡ç½®è¡¨å•
        });
    </script>
</body>
</html>
