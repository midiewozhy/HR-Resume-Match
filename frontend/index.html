<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen text-xl">
    <div class="bg-white p-12 rounded-xl shadow-lg w-[600px] space-y-10">
        <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">简历匹配</h2>
        
        <!-- Output & Tasklog Area (side by side) -->
        <div class="flex space-x-12 w-full text-xl">
            <div class="flex-1">
                <label class="block text-gray-700 mb-3 text-xl">结果</label>
                <div id="outputArea" class="bg-gray-50 border rounded-lg p-10 h-80 overflow-auto w-full"></div>
            </div>
            <div class="flex-1">
                <label class="block text-gray-700 mb-3 text-xl">进程</label>
                <div id="tasklogArea" class="bg-gray-50 border rounded-lg p-10 h-80 overflow-auto w-full"></div>
            </div>
        </div>
        
        <!-- PDF Upload Area with icon and instruction -->
        <form id="uploadForm">
            <div>
                <label class="block text-gray-700 mb-3 text-xl">简历上传</label>
                <div class="flex items-center space-x-5 bg-gray-50 border rounded-lg p-5">
                    <!-- PDF Icon (Heroicons) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0 0V8m0 4h4m-4 0H8m8 4v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v7a2 2 0 01-2 2h-1"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-gray-600 text-lg mb-2">请上传PDF文件</p>
                        <input id="resumePdf" name="resumePdf" type="file" accept="application/pdf" class="block w-full text-gray-700 border rounded-lg p-4 text-lg"/>
                    </div>
                </div>
            </div>
            
            <!-- Paper URLs Upload Area -->
            <div>
                <label class="block text-gray-700 mb-2 text-xl">论文1</label>
                <input id="paperUrl1" type="url" placeholder="第一篇论文（可选）" class="block w-full border rounded-lg p-4 mb-4 text-lg"/>
                <label class="block text-gray-700 mb-2 text-xl">论文2</label>
                <input id="paperUrl2" type="url" placeholder="第二篇论文（可选）" class="block w-full border rounded-lg p-4 text-lg"/>
            </div>
        </form>


        <!-- Buttons -->
        <div class="flex space-x-6">
            <button id="startBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition">
                开始任务
            </button>
            <button id="resetBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition">
                重置任务
            </button>
        </div>
    </div>
    <script>
        // 获取按钮元素
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tasklogArea = document.getElementById('tasklogArea');
        const outputArea = document.getElementById('outputArea');

        // 定义一个addLog函数
        function addLog(message, type = 'info') {
            //const timestamp = new Date();
            //const timeString = timestamp.toLocaleTimeString(); 暂时没有用
            
            // 创建日志条目
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            // 设置图标
            let icon = 'ℹ️';
            switch(type) {
                case 'error': icon = '⚠️'; break;
                case 'success': icon = '✅'; break;
            }
            
            logEntry.innerHTML = `
                <div class="log-icon">${icon}</div>
                <div class="log-content">${message}</div>
            `;
            
            tasklogArea.appendChild(logEntry);
            
            // 自动滚动到底部
            tasklogArea.scrollTop = tasklogArea.scrollHeight;
        }

        // 定义一个接收resumePdf的函数
        function handleResumePdf(resumePdf) {
            // 1. 先上传PDF文件到/upload/pdf接口
            const pdfOnlyFormData = new FormData();
            pdfOnlyFormData.append('file', resumePdf);

            fetch('http://localhost:5000/api/resources/upload/pdf', {
                method: 'POST',
                body: pdfOnlyFormData,  // 直接传入FormData对象
                credentials: 'include'  // 跨域请求时确保携带cookie等凭证
            })
            .then(response => {
                return response.json().then(json => {
                    if (!response.ok) {
                        throw new Error(json.message || 'PDF上传失败');
                    }
                    return json;  // 上传成功后，后端应返回file_temp_path
                });
            })
            .then(uploadData => {
                // 2. 上传成功后，调用/extract接口提取内容
                console.log('PDF上传成功，开始提取内容...', uploadData);
                addLog(uploadData.message, 'success');
                console.log(uploadData.file_temp_path);

                // 从上传响应中获取临时文件路径（关键参数）
                const fileTempPath = uploadData.file_temp_path;
                if (!fileTempPath) {
                    throw new Error('文件找不到了呢，请重试一下呢~');
                }

                // 3. 调用/extract接口，传入file_temp_path
                return fetch('http://localhost:5000/api/resources/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'  // 发送JSON数据需指定头部
                    },
                    body: JSON.stringify({
                        file_temp_path: fileTempPath  // 传递临时文件路径
                    }),
                    credentials: 'include'  // 跨域请求时确保携带cookie等凭证
                });
            })
            .then(response => {
                // 4. 处理/extract接口的响应
                return response.json().then(json => {
                    if (!response.ok) {
                        throw new Error(json.message || '内容提取失败');
                    }
                    return json;  // 提取成功的完整数据（含resume_content）
                });
            })
            .then(extractData => {
                // 5. 提取内容成功，处理结果
                console.log('内容提取成功:', extractData);
                addLog(extractData.message || '简历内容提取完成，现在开始提取链接~', 'success');
                return true;  // 返回true表示简历处理成功
            })
            .catch(error => {
                // 统一处理所有环节的错误（上传失败/提取失败）
                console.error('处理失败:', error);
                addLog(error.message || '处理简历时出错，请重试', 'error');
                return false;  // 返回false表示简历处理失败
            });
        }

        // 定义一个接收paperUrl1和paperUrl2的函数
        function handlePaperUrls(paperUrl1, paperUrl2) {
            // 如果两个URL都为空，直接返回（跳过处理）
            if (!paperUrl1 && !paperUrl2) {
                addLog('没有论文链接哟，我们就跳过啦~', 'info');
                return true;
            }
            
            // 显示处理状态
            addLog('正在验证论文链接，请稍候...', 'info');
            
            // 准备数据（保持与后端字段名一致）
            const data = {
                paper_url_1: paperUrl1 || null,
                paper_url_2: paperUrl2 || null
            };
            
            // 发送请求到后端
            fetch('http://localhost:5000/api/resources/upload/paper_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
                credentials: 'include'  // 确保携带session cookie
            })
            .then(response => {
                return response.json().then(json => {
                    if (!response.ok) {
                        throw new Error(json.message || '论文链接处理失败');
                    }
                    return json;
                });
            })
            .then(result => {
                // 根据后端状态码和消息更新日志
                if (result.status === 'success') {
                    addLog(result.message, 'success');
                } else if (result.status === 'info') {
                    addLog(result.message, 'info');
                } else {
                    addLog(result.message, 'warning');
                }
                
                // 触发后续分析（如果简历和论文都已上传）
                if (userHasUploadedResume()) {
                    setTimeout(() => {
                        addLog('简历与论文均已准备好，正在进行综合分析...', 'info');
                        // 这里可以调用联合分析的接口
                    }, 1000);
                }
                return true;  // 返回true表示链接处理成功
            })
            .catch(error => {
                if (error.name === 'TypeError') {
                    // 处理网络错误（如跨域、连接失败）
                    addLog('网络连接失败，请检查后端服务是否运行', 'error');
                } else if (error.name === 'SyntaxError') {
                    // 处理无效 JSON 响应
                    addLog('服务器响应格式错误，请联系技术支持', 'error');
                } else {
                    // 处理其他错误
                    addLog(error.message || '处理简历时出错，请重试', 'error');
                }
                console.error('处理失败:', error);
                return false;  // 返回false表示链接处理失败
            });
        }

        // 展示输出的结果
        function llmOutput() {
            // 获取输出区域DOM元素
            const outputArea = document.getElementById('outputArea');
            if (!outputArea) {
                console.error('未找到输出区域，请检查id是否为"outputArea"');
                return;
            }

            // 初始化输出区域状态
            outputArea.classList.remove('output-success', 'output-error');
            outputArea.classList.add('output-loading');
            outputArea.innerHTML = '正在分析内容，请稍候...';
            addLog('开始生成分析结果...', 'info');

            // 调用后端分析接口
            fetch('http://localhost:5000/analyze', {
                method: 'GET',
                credentials: 'include' // 携带session信息，关联用户数据
            })
            .then(response => {
                return response.json().then(data => {
                    if (!response.ok) {
                        // 后端返回错误状态（如APIEmptyError）
                        throw new Error(data.message || '分析过程出现问题，请重试');
                    }
                    return data;
                });
            })
            .then(result => {
                // 成功处理：移除加载状态，添加成功样式
                outputArea.classList.remove('output-loading');
                outputArea.classList.add('output-success');
                
                // 格式化分析结果（支持对象和字符串类型）
                const analysisData = result.data;
                let outputHtml = '';
                
                if (typeof analysisData === 'object' && analysisData !== null) {
                    // 若为对象，按键值对格式化
                    outputHtml = Object.entries(analysisData).map(([key, value]) => `
                        <div class="output-item">
                            <span class="output-key">${key}：</span>
                            <span class="output-value">${value}</span>
                        </div>
                    `).join('');
                } else {
                    // 若为字符串，直接展示
                    outputHtml = `<div class="output-plain">${analysisData}</div>`;
                }
                
                outputArea.innerHTML = outputHtml;
                addLog('分析完成，结果已展示', 'success');
            })
            .catch(error => {
                // 错误处理：移除加载状态，添加错误样式
                outputArea.classList.remove('output-loading');
                outputArea.classList.add('output-error');
                outputArea.innerHTML = error.message;
                addLog(error.message, 'error');
            });
        }
        // 点击事件处理（确保传入完整的formData）
        startBtn.addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('uploadForm'));
            
            // 检查是否上传了简历
            const resumeFile = formData.get('resumePdf');
            if (!resumeFile || resumeFile.size === 0) {
                addLog('请先上传简历文件~', 'error');
                return;
            }

            addLog('开始处理简历，请稍等...', 'info');

            // 分离数据
            const resumePdf = formData.get('resumePdf');
            const paperUrl1 = formData.get('paperUrl1');
            const paperUrl2 = formData.get('paperUrl2');

            // 处理简历数据
            const resumeProcessed = await handleResumePdf(resumePdf);
            if (!resumeProcessed) {
                addLog('简历处理失败，请重试', 'error');
                return;
            } else {
                const urlsProcessed = await handlePaperUrls(paperUrl1, paperUrl2);
            }

        });

    </script>
</body>
</html>
