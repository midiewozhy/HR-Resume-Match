<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简历匹配系统</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            content: ["./*.html"],
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#10b981',
                        danger: '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex items-center justify-center p-4">
    <!-- 主容器（使用原生Tailwind类） -->
    <div class="bg-white p-6 md:p-10 rounded-xl max-w-4xl w-full mx-4 card-shadow">
        <!-- 标题 -->
        <h2 class="text-2xl md:text-3xl font-bold text-primary mb-6 text-center">简历匹配系统</h2>
        
        <!-- 输出与日志区域 -->
        <div class="flex flex-col md:flex-row gap-6 w-full">
            <div class="flex-1">
                <label class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                    分析结果
                    <span class="flex-1 h-px bg-gray-200 ml-3"></span>
                </label>
                <div id="outputArea" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-72 md:h-80 overflow-auto">
                    <div class="text-gray-500 italic">请上传简历并点击"开始任务"，分析结果将显示在这里</div>
                </div>
            </div>
            <div class="flex-1">
                <label class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
                    处理日志
                    <span class="flex-1 h-px bg-gray-200 ml-3"></span>
                </label>
                <div id="tasklogArea" class="bg-gray-50 border border-gray-200 rounded-lg p-4 h-72 md:h-80 overflow-auto">
                    <div class="text-gray-500 italic">系统操作日志将显示在这里...</div>
                </div>
            </div>
        </div>
        
        <!-- 表单 -->
        <form id="uploadForm" class="space-y-6">
            <div>
                <label for="resumePdf" class="text-base font-medium text-gray-700 mb-2 block">简历上传</label>
                <div class="flex flex-col md:flex-row gap-4 p-5 bg-gray-50 border border-gray-200 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-danger" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4m0 0V8m0 4h4m-4 0H8m8 4v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v7a2 2 0 01-2 2h-1"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-gray-500 text-sm">支持PDF格式，大小不超过10MB</p>
                        <input id="resumePdf" name="resumePdf" type="file" accept="application/pdf" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
                    </div>
                </div>
            </div>
            
            <div>
                <label for="paperUrl1" class="text-base font-medium text-gray-700 mb-2 block">论文链接1（可选）</label>
                <input id="paperUrl1" name="paperUrl1" type="url" placeholder="例如：https://arxiv.org/abs/xxx" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all mb-4" />
                
                <label for="paperUrl2" class="text-base font-medium text-gray-700 mb-2 block">论文链接2（可选）</label>
                <input id="paperUrl2" name="paperUrl2" type="url" placeholder="例如：https://github.com/xxx" class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
            </div>
        </form>
        
        <!-- 按钮区域 -->
        <div class="flex flex-wrap gap-4 pt-2">
            <button id="startBtn" class="font-medium py-3 px-6 rounded-lg text-base bg-primary text-white hover:bg-primary/90 hover:shadow-md active:scale-95 transition-all duration-200">
                开始任务
            </button>
            <button id="resetBtn" class="font-medium py-3 px-6 rounded-lg text-base bg-gray-600 text-white hover:bg-gray-700 hover:shadow-md active:scale-95 transition-all duration-200">
                重置任务
            </button>
        </div>
    </div>
    <script>
        // 获取按钮元素
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const tasklogArea = document.getElementById('tasklogArea');
        const outputArea = document.getElementById('outputArea');

        function saveLogsToStorage() {
            const logEntries = Array.from(tasklogArea.querySelectorAll('.log-entry'))
                .map(entry => ({
                    message: entry.querySelector('.log-content').textContent,
                    type: entry.className.split(' ').find(cls => cls.startsWith('log-'))?.replace('log-', '') || 'info'
                }));
            
            localStorage.setItem('taskLogs', JSON.stringify(logEntries));
        }

        // 从localStorage恢复日志
        function loadLogsFromStorage() {
            const savedLogs = localStorage.getItem('taskLogs');
            if (savedLogs) {
                try {
                    const logs = JSON.parse(savedLogs);
                    logs.forEach(log => addLog(log.message, log.type));
                } catch (e) {
                    console.error('Failed to load logs from storage', e);
                    localStorage.removeItem('taskLogs'); // 清除损坏的日志数据
                }
            }
        }

        // 清空日志（用于重置按钮）
        function clearLogs() {
            tasklogArea.innerHTML = '';
            localStorage.removeItem('taskLogs');
        }

        // 定义一个addLog函数
        function addLog(message, type = 'info') {
            //const timestamp = new Date();
            //const timeString = timestamp.toLocaleTimeString(); 暂时没有用
            
            // 创建日志条目
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            // 设置图标
            let icon = 'ℹ️';
            switch(type) {
                case 'error': icon = '⚠️'; break;
                case 'success': icon = '✅'; break;
            }
            
            logEntry.innerHTML = `
                <div class="log-icon">${icon}</div>
                <div class="log-content">${message}</div>
            `;
            
            tasklogArea.appendChild(logEntry);
            
            // 自动滚动到底部
            tasklogArea.scrollTop = tasklogArea.scrollHeight;
        
            saveLogsToStorage();
        }

        // 定义一个接收resumePdf的函数
        function cdd_analysis(formData){
                if (!formData.get('paperUrl1') && !formData.get('paperUrl2')) {
                    addLog('没有论文链接的话，我们就跳过咯~', 'info');
                }
                addLog('开始进行简历分析...', 'info');
                fetch('http://localhost:5000/api/llm/cdd/analysis', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error;
                    }
                    return response.json();
                })
                .then(result =>{
                    if (result.status === 'success') {
                        addLog('简历分析完成！', 'success');
                        outputArea.innerHTML = `<pre>${JSON.stringify(result.data, null, 2)}</pre>`;
                    } else {
                        addLog(`分析失败：请重试一下吧`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`分析过程中发生错误：${error.message}`, 'error');
                });
            };

        // 页面加载时恢复日志
        //window.addEventListener('load', loadLogsFromStorage);

        // 点击事件处理（确保传入完整的formData）
        startBtn.addEventListener('click', async function() {
            clearLogs(); // 清空日志区域
            const formData = new FormData(document.getElementById('uploadForm'));
            
            // 检查是否上传了简历
            const resumeFile = formData.get('resumePdf');
            if (!resumeFile || resumeFile.size === 0) {
                addLog('请先上传简历文件~', 'error');
                return;
            }

            addLog('正在处理数据，请稍等...', 'info');
            cdd_analysis(formData);
        });

        // 重置按钮点击事件
        resetBtn.addEventListener('click', function() {
            clearLogs(); // 清空日志区域
            outputArea.innerHTML = '<div class="text-gray-500 italic">请上传简历并点击"开始任务"，分析结果将显示在这里</div>';
            document.getElementById('uploadForm').reset(); // 重置表单
        });
    </script>
</body>
</html>
